---
title: "Andrew Code"
author: "Andrew Spika"
date: "2023-11-21"
output: html_document
---

```{r}
library(tidyverse)
library(devtools)
library(stringr)
```


```{r}
# Andrew Code
combine <- read.csv("nfl.combine.csv")
combine <- combine %>% filter(Position=="QB")

combine$PlayerName <- strsplit(combine$Player, '\\\\')


combine$PlayerID <- combine$Player %>% strsplit()

career.stats <- read.csv("Career_Stats_Passing.csv")

```

```{r, message=FALSE}
devtools::install_github(repo = "maksimhorowitz/nflscrapR")

```

```{r}
season.passing <- read.csv("season_passing_df.csv")
season.receiving <- read.csv("season_receiving_df.csv")
season.rushing <- read.csv("season_rushing_df.csv")
```

```{r}
combine.2000 <- read.csv("combine.qb2000.csv")
combine.2000$Player_Name <- str_replace(combine.2000$Player, '[a-z]+ ', '.')
# QB rushing stats
season.rushing


```

```{r}
qbs <- read.csv("qbStats.csv")
combine.qb <- read.csv("combine.qb")
qbs
combine.qb
combine.qb$qbnames <- str_split(combine.qb$Player.Name, "\\\\")
for(i in 1:nrow(combine.qb)) {
  combine.qb$qb[i] <- combine.qb$qbnames[[i]][1]
}
combine.qb$qbnames <- unlist(combine.qb$qbnames)

qbs$qbnames <- str_split(qbs$qb, ' [A-Z]{1}[a-z]+\\. ')

joined.qbs <- qbs %>% left_join(combine.qb, by="qbnames")

```

```{r}
total.qb <- read.csv("totalCombinedQB.csv")
total.qb$ypa <- total.qb$yds / total.qb$att
total.qb

results <- lm(cbind(td, yds)~cmp+att+int, data=total.qb)
summary(results)

numeric.qb <- total.qb %>% dplyr::select(c(att, cmp, yds, ypa, td, int, sack, loss, game_points, Ht, Wt, Forty, Vertical, BroadJump, Year, Cone, Shuttle))

cor(numeric.qb)
```

```{r}
library(car)
library(pls)
season <- read.csv("qbStats.csv")
season.mlm <- lm(cbind(yds, td, game_points) ~ att+cmp+ypa+int+sack+loss+experience, data=season)
summary(season.mlm)

# Anova for the MLM shows that loss can be dropped from the model
Anova(season.mlm)

# Large p value from anova table with updated mlm shows that the 'loss' variable can be dropped because the model fits as well
season.mlm2 <- update(season.mlm, .~.-loss)
anova(season.mlm, season.mlm2)

# Test statistics from the linear hypothesis test show that the 'loss' variable can be dropped
lh.out <- linearHypothesis(season.mlm, hypothesis.matrix = c("loss = 0"))
lh.out
season.mlm2
qqnorm(season.mlm2$residuals[,1]); qqline(season.mlm2$residuals[,1])
qqnorm(season.mlm2$residuals[,2]); qqline(season.mlm2$residuals[,2])
qqnorm(season.mlm2$residuals[,3]); qqline(season.mlm2$residuals[,3])
```

```{r}
qb.data <- read.csv("career_combinedStats.csv")
head(qb.data)

qb.mlm <- lm(cbind(yds, td, game_points)~att+cmp+ypa+int+sack+loss+experience, data=qb.data)
summary(qb.mlm)

Anova(qb.mlm)

qb.mlm2 <- update(qb.mlm, .~.-ypa, data=qb.data)
Anova(qb.mlm2)
anova(qb.mlm, qb.mlm2)
```

```{r}
library(psych)
# Grab numerical data
numerical.qb <- qb.data %>% select(c(att, cmp, yds, int, ypa, td, int, sack, loss, game_points, experience, Ht, Wt, Year))

# Create correlation matrix to test in the cortest-bartlett test
mat <- cor(numerical.qb)

# Test to see if factor analysis could be used here
cortest.bartlett(mat, n=length(numerical.qb)) # small p value means EFA may be useful here

KMO(mat)

numerical.qb.2 <- numerical.qb %>% select(-c(Ht, Wt, Year))
mat2 <- cor(numerical.qb.2)

KMO(mat2)

# Choosing number of factors
output <- princomp(numerical.qb.2, cor=TRUE)
plot(output,type="lines") # scree plot 
abline(h=1,lty=2)  # add horizonal dotted line at 1
# Based on this, 2 factors should suffice

# Extract factors
fa.out <- principal(numerical.qb.2 ,nfactors=2, rotate="varimax")
print.psych(fa.out,cut=.5,sort=TRUE)
fa.out$scores
```

